<source>
   @type forward
   port 24224
   bind 0.0.0.0
</source>

########## NGINX ##########
<source>
   @type tail
   path /var/log/nginx/access.log
   pos_file /var/log/fluent/nginx-access.log.pos
   tag acho.nginx.access
   refresh_interval 5
   encoding UTF-8
   <parse>
      @type nginx
      types code:integer,size:integer,time:time
   </parse>
</source>

<source>
   @type tail
   path /var/log/nginx/error.log
   pos_file /var/log/fluent/nginx-error.log.pos
   tag acho.nginx.error
   refresh_interval 5
   encoding UTF-8
   <parse>
      @type regexp
      expression ^(?<time>\d{4}\/\d{2}\/\d{2} \d{2}:\d{2}:\d{2}) \[(?<level>[^\]]*)\] (?<pid>\d+)#(?<tid>\d+): (\*(?<cid>\d+) )?(?<message>.*)$
      time_format %Y/%m/%d %T
      types time:time,pid:integer,tid:integer,cid:integer
   </parse>
</source>

########## PHP-FPM ##########
<source>
   @type tail
   path /var/log/php-fpm/access.log
   pos_file /var/log/fluent/php-fpm-access.log.pos
   tag acho.php-fpm.access
   refresh_interval 5
   encoding UTF-8
   <parse>
      @type regexp
      expression ^(?<remote>[^ ]*) - (?<user>[^ ]*) (?<time>[^ ]* \+\d{4}) "(?<method>\S+)(?: +(?<path>[^\"]*?)(?: +\S*)?)?" (?<code>[^ ]*)
      time_format %d/%b/%Y:%H:%M:%S %z
      types time:time,code:integer
   </parse>
</source>

<source>
   @type tail
   path /var/log/php-fpm/error.log
   pos_file /var/log/fluent/php-fpm-error.log.pos
   tag acho.php-fpm.error
   refresh_interval 5
   encoding UTF-8
   <parse>
      @type regexp
      expression ^\[(?<time>[^\]]*)\] (?<level>\w*): (?<message>.*)$
      time_format %v %T
      types time:time
   </parse>
</source>

<source>
   @type tail
   path /var/log/php-fpm/www-error.log
   pos_file /var/log/fluent/php-fpm-www-error.log.pos
   tag acho.php-fpm.www-error
   refresh_interval 5
   encoding UTF-8
   <parse>
      @type multiline
      format_firstline /^\[[^\]]*?\]/
      format1 /^\[(?<time>[^\]]*?)\] PHP (?<level>.*):  (?<message>.*)/
      time_format %d-%b-%Y %H:%M:%S %Z
   </parse>
</source>

########## JAVA GC ##########
<source>
   @type tail
   path /var/log/apps-java/acho-java-gc_beta.log
   pos_file /var/log/fluent/acho-java-gc_beta.log.pos
   tag acho.apps-java-gc.beta
   refresh_interval 5
   encoding UTF-8
   <parse>
      @type regexp
      expression ^(?<message>.*)$
   </parse>
</source>

<source>
   @type tail
   path /var/log/apps-java/acho-java-gc_pro.log
   pos_file /var/log/fluent/acho-java-gc_pro.log.pos
   tag acho.apps-java-gc.pro
   refresh_interval 5
   encoding UTF-8
   <parse>
      @type regexp
      expression ^(?<message>.*)$
   </parse>
</source>

########## APPS LOG ##########
<source>
   @type tail
   path /var/log/apps/*.log
   pos_file /var/log/fluent/acho-console.log.pos
   exclude_path ["/var/log/apps/acho-beta.log", "/var/log/apps/acho-pro.log"]
   tag acho.apps.pro
   path_key file_path
   refresh_interval 5
   encoding UTF-8
   <parse>
      @type regexp
      expression ^(?<message>.*)$
   </parse>
</source>

<source>
   @type tail
   path /var/log/apps/acho-pro.log
   pos_file /var/log/fluent/acho-pro.log.pos
   tag acho.apps.pro
   path_key file_path
   refresh_interval 5
   encoding UTF-8
   <parse>
      @type regexp
      expression ^(?<time>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}) \[(?<level>[^\]]*)\]:(?<request_id>[^ ]*) <(?<event>.*)> - (?<message_text>.*)$
      time_format %F %T
      types time:time
   </parse>
</source>

########## Parse Json to decode UTF-8 format ##########
<match acho.apps.**>
   @type copy
   <store>
      @type relabel
      @label @PARSE_JSON
   </store>
   <store>
      @type relabel
      @label @NOT_TO_PARSE_JSON
   </store>
</match>

<label @PARSE_JSON>
   <filter acho.apps.**>
      @type grep
      <regexp>
         key message_text
         pattern /^\"/
      </regexp>
   </filter>
   <filter acho.apps.**>
      @type parser
      key_name "$.message_text"
      hash_value_field "message"
      reserve_data true
      remove_key_name_field true
      <parse>
         @type json
      </parse>
   </filter>
   <match acho.apps.**>
      @type relabel
      @label @OK
   </match>
</label>

<label @NOT_TO_PARSE_JSON>
   <filter acho.apps.**>
      @type grep
      <exclude>
         key message_text
         pattern /^\"/
      </exclude>
   </filter>
   <match acho.apps.**>
      @type relabel
      @label @OK
   </match>
</label>

<label @OK>
   <match acho.apps.**>
      @type forward
      send_timeout 1s
      recover_wait 10s
      hard_timeout 3s

      <buffer>
         flush_mode interval
         flush_interval 5s
      </buffer>

      <server>
         name vmss-external-server
         host vmss-external-server
         port 24224
         weight 60
      </server>
      <secondary>
         @type file
         path /var/log/fluent/forward-failed
      </secondary>
   </match>
</label>

########## Matching Rules ##########
<match acho.**>
   @type forward
   send_timeout 1s
   recover_wait 10s
   hard_timeout 3s

   <buffer>
      flush_mode interval
      flush_interval 5s
   </buffer>

   <server>
      name vmss-external-server
      host vmss-external-server
      port 24224
      weight 60
   </server>
   <secondary>
      @type file
      path /var/log/fluent/forward-failed
   </secondary>
</match>

########## Matching Rules for Fluentd ##########
<match fluent.*>
   @type file
   path /var/log/fluent/fluent.%Y-%m-%d
   append true
   compress gzip
   <buffer time>
      @type file
      path /var/log/fluent/buffer
      timekey 1d
      timekey_wait 1m
      flush_mode interval
      flush_interval 3
   </buffer>
</match>
